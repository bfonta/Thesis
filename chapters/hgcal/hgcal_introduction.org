<<sec:hgcal_intro>>

Following the \ac{HL-LHC} description in ref:sec:hllhc, it should be clear that the running conditions during data collection will happen in a much harsher and crowded environment, with respect to the \ac{LHC}.
This is particularly true for the \ac{CMS} endcap regions, given the extremely large radiation levels expected closer to the beam axis.
The \ac{ECAL} and \ac{HCAL} forward calorimeters were designed to sustain an integrated luminosity of \SI{500}{\invfb}.
Given the \num{\sim 6} to \num{8} times larger luminosities expected for the \ac{HL-LHC}, a degration of the physics performance after @refer to some lumi projectin over time for the HL-LHC@ unavoidable [[cite:&hgcal_technical_proposal]].

The CMS experiment thus foresees the complete replacement of the endcap calorimeters with a profoundly different calorimeter. It is clear from simulations that the new sub-detector will have to withstand a fluence of $10^{16}~\rm n_{eq}/cm^2$ and a dose of 2 MGy (cfr Fig.~\ref{ch2:fig:dose}). R&D activities have proven that the best material to meet these requirements is silicon, which can cope with fluences up to $1.5\times10^{16}~\rm n_{eq}/cm^2$, 50% higher than the one expected during phase-2. Hence, silicon was selected to be the active material of the new detector. In addition to radiation hardness, the new calorimeter must satisfy other requirements outlined below.

\Ac{CMS} [[cite:&cms_collab]] is thus developing the \ac{HGCAL} [[cite:&hgcalTDR]]: a novel endcap sampling calorimeter with an extremely fine granularity.
About \num{6} million channels will enable particle identification and high resolution measurements of the position, energy and time of high-energy collision products.
Examples include the measurement of narrow and merged jets, \ac{PU} energy, and performing calorimetric tracking for the first time.
Given its location and number of active sensors, data rates of \SI{\sim 100}{\tera\byte\per\second} are expected.
The latter is a novel endcap calorimeter with fine transverse and longitudinal granularity, capable of fully exploiting the physics events produced under the expected tight time budget and extreme radiation conditions.
The proposed design of \ac{HGCAL} includes two sections measuring the properties of different types of particles.
The \ac{EM} section covers the first 26 layers, closer to the interaction point.
There, \ac{Si} sensors organized in hexagonal modules act as active material, in order to sustain the expected radiation.
Layers of \ac{Si} are interleaved with absorbers.
The following 21 layers, comprising the \ac{HAD} section, are split into 8 \ac{Si}-only layers followed by 14 hybrid layers, with \ac{Si} closer to the beamline and cost effective plastic scintillator at lower \ac{eta} values (see \cref{fig:hgcal}). 
Each endcap weighs \SI{215}{\tonne} and measures \SI{2}{\meter} (\SI{2.3}{\meter}) in the longitudinal (radial) direction.
Ac{HGCAL} will be integrated with the online firmware trigger system put in place by \ac{CMS}, the \ac{L1} [[cite:&l1TDR]], which precedes the \ac{HLT} running on standard servers.
\Ac{L1} performs an online selection of interesting physics processes, whose cross sections are typically orders of magnitude lower than the total proton-proton cross section.
We present and discuss several techniques to minimize or completely remove the splitting.
We conclude by discussing future steps, some of which are already in progress.


#+NAME: fig:hgcal
#+ATTR_LATEX: :width 1.\textwidth
#+CAPTION: Schematic views of \ac{HGCAL}. \textit{a)} Longitudinal profile of positive endcap with highlighted \ac{eta} range and \ac{EM} and \ac{HAD} sections /b)/ Transversal view of a \ac{Si}-only layer, with different colors representing different sensor thicknesses /c)/ Same as \textit{b} for a hybrid layer /d)/ 3D view of \ac{HGCAL}.
[[~/org/PhD/Thesis/figures/hgcal/hgcal_mod.png]]


* GPU1 :noexport:
[[cite:&refCUDA1]]

The High Luminosity LHC (HL-LHC) will start taking data in 2029, achieving unprecedented
instantaneous luminosities of ∼5 × 1034 cm2 s−1 (more than twice LHC’s current value) and a
pileup of up to 200. An integrated luminosity of ∼3 ab−1 will be reached over 10 years [1, 2].
In order to cope with the above, a major upgrade of the CMS endcap calorimeters [3, 4]
is being prepared. The novel High Granularity Calorimeter (HGCAL) [2] is an extremely
challenging project, requiring the development of reconstruction code capable of fully exploiting
the increased granularity under the expected extreme conditions.
The biggest contributor to CPU usage is event reconstruction, of which currently ∼5% is
used by HGCAL [5]. CMS plans to port part of its reconstruction to Graphics Processing
Units (GPUs), which represent one of the most promising hardware accelerator technologies on
the market. GPUs are a key element when one considers taking advantage of heterogeneous
architectures available on traditional and High-Performance Computing grid sites, including the
upgraded Worldwide LHC Computing Grid. GPUs also promote the development of algorithms
with better computing performance, and profit from a potentially favourable cost when compared
to CPUs, per unit capacity. CMS is planning to adopt a heterogeneous High Level Trigger (HLT)
farm already in Run 3 (2022–2025), where ∼30% of the workflow will be offloaded to GPUs (50%
and 80% by the end of Run 4 and 5, respectively) [6]. 

HGCAL will be a sampling calorimeter. The proposed design includes an electromagnetic section
of silicon sensors as active material in the first 28 layers. A hadronic section comprises 8 silicon-
only layers followed by 14 silicon-scintillator hybrid layers, where the scintillation light is read
out by silicon photo-multipliers. Both sections are interleaved with absorber layers. HGCAL
will comprise ∼620 m2 of silicon and ∼400 m2 of plastic scintillators for a total of, respectively,
∼6 million and ∼240 thousand channels. Three subdetectors form HGCAL’s hybrid detection
technology: the first 28 layers made exclusively of silicon (CE-E) and the silicon and scintillator
parts of the hadronic section (CE-HSi and CE-HSci). The reconstruction model envisioned for
HGCAL is intended to be fast and flexible, comprising a sequence of modules/stages which
transform raw data into physics objects. After the initial generation, simulation, digitization [5]
and calibration steps, energy deposits (hits) are clustered by CLUE, a fully-parallelizable density-
based clustering algorithm [8], in order to form two-dimensional objects. In a nutshell, CLUE
assigns an energy density and a separation distance to all hits, which are later used to classify
each hit as either a seed, a follower (based on the hit’s nearest highest density), or an outlier.
Clusters are built by traversing the tree of followers of each seed, assigning the index of the
seed to all its followers. This work includes the calculation of the cluster energy and cartesian
positions, which are computed in the device (section 3.1). In addition, a heterogeneous approach
for navigating through the detector’s geometrical/topological information is devised and used
within CLUE (section 3.2).

* GPU2 :noexport:
[[cite:&refCUDA2]]

The operation of the High Luminosity LHC (HL-LHC) is expected to commence in 2027,
achieving instantaneous luminosities of ∼5 × 10 34 cm2 s−1 , more than two times LHC’s cur-
rent value. Over 10 years it will reach an integrated luminosity of ∼3 ab−1 , with potentially
up to 200 proton collisions (pileup) per bunch crossing. The goals of the HL-LHC include
measuring the Higgs boson (self) couplings, vector boson fusion and vector boson scattering
processes (also involving the Higgs boson), and B physics processes, among others [1].
In accordance with this programme, the upgrade of the CMS detector [2] foresees a High
Granularity Calorimeter (HGCAL) [3] to replace the current endcap calorimeters. One of the
challenges posed to CMS by the new calorimeter is writing reconstruction code allowing its
full exploitation.
Present projections show a gap between projected CPU needs and availability at the start
of the HL-LHC (Run4), as displayed in Fig. 1. The biggest contributor to CPU usage is event
reconstruction (see Fig. 2), of which currently ∼6% is used by HGCAL. CMS plans to port
some parts of its reconstruction to Graphics Processing Units (GPUs), which represent one of
the most promising accelerator technologies on the market. Its adoption would allow access
to accelerators, which become more and more present on High-Performance Computing and
traditional grid sites. It would also be in line with the direction taken by CMS to adopt a
heterogeneous HLT farm already in Run 3. Finally, it potentially reduces the cost of the
computing capacity necessary to satisfy the CMS physics programme, since computation on
GPUs might be cheaper than on CPUs.


The HGCAL will be a sampling calorimeter. The proposed design includes, as active ma-
terial, silicon (Si) sensors in the front 28 layers of its electromagnetic section (CE-E). The
hadronic section (CE-H) comprises 8 Si-only layers followed by 14 Si-scintillator hybrid lay-
ers, where the scintillation light is read out by Si photo-multipliers (see Fig. 3). The Si sensors
are further subdivided into three types with varying thicknesses (120, 200 and 300 μm), ca-
pacitances and sizes, to withstand different fluence conditions. The absorbers will be made of
CuW, Pb and Cu in the CE-E and stainless steel and Cu in the CE-H, and its thicknesses will
vary across layers. The electromagnetic radiation and hadronic interaction lengths of CE-E
are 25 X 0 and 1.3 λ respectively, while the hadronic interaction length of CE-H is 8.2 λ. In
total, the full HGCAL system has ∼620 m 2 of Si and ∼400 m 2 of plastic scintillators. The
size of each Si sensor is 0.5 cm 2 to 1.0 cm 2 (120 μm Si sensors are smaller). Scintillators
will range in size from 4 to 30 cm 2 , and the number of Si (scintillator) channels is ∼6 million
(∼240 thousand). Each endcap weighs ∼215 t and measures ∼2 m (∼2.3 m) in longitudinal
(radial) direction. The full system operates at a temperature of −35 ◦C maintained by a CO 2
cooling system [3].
Due to HGCAL’s hybrid detection technology, three subdetectors are considered inde-
pendently for both the CPU and GPU implementation of the reconstruction algorithms:
• CE-E: comprises the first 28 layers made exclusively of Si;
• CE-HSi : covers the Si part of the CE-H section;
• CE-H Sci : covers the scintillator part of the CE-H section.

The current reconstruction model envisioned for HGCAL, part of CMSSW and succinctly
depicted in Fig. 4, is intended to be fast and flexible. It comprises a series of modules which
transform raw data into physics objects. After the first stages described in [4], one obtains
UncalibRecHits. They represent energy deposits whose amplitude is expressed in terms of the
average number of minimum ionizing particles (MIPs), after being converted from analog-to-
digital converter (ADC) counts by the previous Digi step, and taking the sensor thickness into
account. This paper covers the following step, i.e., rescaling the hits to produce a CMSSW
collection of RecHits (see Section Section 4). Continuing along the chain, the software then
clusters the RecHits into two-dimensional layer clusters, using CLUE [8]. Finally, taking the
clusters as its input, The Iterative CLustering (TICL) framework [9] produces 3D objects and
showers using a mixture of pattern recognition, energy regression and particle identification
techniques. In parallel, a heterogeneous way of navigating through geometrical and topolog-
ical information within the detector (such as information regarding Si sensors or plastic tiles)
is being investigated, in order to accelerate and facilitate its access by different algorithms
in the chain. The constant need to retrieve the x and y coordinates (in HGCAL’s transversal
plane) in CLUE is an example of these navigation challenges

* Possible references
+ [[cite:&cms_offline_computing]]
+ [[cite:&hgcalTDR]]

  
* Alessandro :noexport:
The existing ECAL and HCAL forward calorimeters were designed for an integrated luminosity of 500 $\rm fb^{-1}$, which is expected to be exceeded shortly after the beginning of the \ac{HL-LHC}. Beyond this point, the physics performance will degrade to an unacceptable level \cite{Contardo:2015bmq}. The CMS experiment thus foresees the complete replacement of the endcap calorimeters with a profoundly different calorimeter. It is clear from simulations that the new sub-detector will have to withstand a fluence of $10^{16}~\rm n_{eq}/cm^2$ and a dose of 2 MGy (cfr Fig.~\ref{ch2:fig:dose}). R\&D activities have proven that the best material to meet these requirements is silicon, which can cope with fluences up to $1.5\times10^{16}~\rm n_{eq}/cm^2$, 50\% higher than the one expected during phase-2. Hence, silicon was selected to be the active material of the new detector. In addition to radiation hardness, the new calorimeter must satisfy other requirements outlined below.
\begin{itemize}
	\item A dense calorimeter to ensure lateral containment of showers.
	\item A fine lateral granularity to allow the separation of close-by showers and the observation of narrow jets. The consequent small cell size will reduce the energy equivalent of electronics noise increasing the S/N ratio. 
	\item A fine longitudinal granularity in order to sample the longitudinal development of showers for good energy resolution, implementing pattern recognition algorithms, and improving PU rejection.
	\item A precise timing measurement that will mainly help in PU rejection and identification of vertices.
	\item The ability to effectively contribute to the L1 decision.
\end{itemize}
The result of all these requirements is the new High Granularity endcap CALorimeter (HGCAL) \cite{CMS:2017jpq}, a sampling calorimeter composed of an electromagnetic section (CE-E) and a hadronic section (CE-H), covering the $1.5<|\eta|<3.0$ region, and weighing 215 tonnes per endcap. The active material will be hexagonal silicon sensors in the more demanding radiation regions, i.e., the entire CE-E compartment and a large fraction of the CE-H sector. The choice of the hexagonal shape is to cover the entire area more efficiently. Instead, in the more outer region of the CE-H, where the dose and fluence will be lowered (dose less than 3 kGy and fluence limited to $8\cdot10^{13}~\rm n_{eq}/cm^2$), the active material will be replaced by cheaper highly-segmented plastic scintillator tile boards. The CE-E will extend for 26 layers, with a sequence of CuW, Cu, stainless steel, and Pb absorbers, for a total radiation length of 27.7$X_0$ and a nuclear length of $1.5\lambda$. On the other hand, the CE-H will extend for 21 layers, with stainless steel as absorber, for a total interaction length of $8.5\lambda$. Everything will be enclosed in a thermally shielded volume at $-35\degree$C, to ensure the proper functioning of the silicon sensors. A summary of the properties of the HGCAL is reported in Fig.~\ref{ch2:fig:HGCALsummary}. \\

The 8-inch hexagonal silicon sensors will be deployed with three different thicknesses of $300$, $200$, and $120~\mu$m, in regions of increasing fluence. In order to optimise the charge collection and reduce the leakage current, it is advantageous to use thinner sensors in the regions of higher fluence. Each silicon sensor will be made of different cells for the readout with two different active areas: 0.52 $\rm cm^2$ for the $120~\mu$m active thickness sensors, and 1.18 $\rm cm^2$ for the $300$ and $200~\mu$m active thickness sensors. This will define two regions in the detector, namely a \textit{high-density} and \textit{low-density} region, depending on the size of the single readout diode. The transition region will be at a radius of $70 \rm ~cm^2$, corresponding to $|\eta|\simeq2.15$. The high-density, i.e., more granular region, is located at higher pseudorapidity, where it is expected a larger number of tracks entering to the HGCAL. 

The silicon sensors will be placed inside \textit{modules}, mounted on one side to a baseplate, and on the other side to the hexaboard containing the front-end electronics and the printed circuit board. The baseplate is composed of CuW in the CE-E, contributing to the CE-E absorber, while in the CE-H the baseplate material is carbon fibre, with a negligible contribution to the CE-H absorber material. These modules are mounted on either side of a 6 mm thick Cu cooling plate that forms, combined with the CuW baseplate, one absorber layer. At a distance of 1.5 mm from the hexaboard, the motherboard groups the hexaboards in larger physical and logical units. A sequence of motherboard-silicon module-motherboard is sandwiched between two 2.1 mm thick lead planes clad with 0.3 mm stainless steel (SS) sheets, forming an alternative absorber layer. This composition leads to an alternate sequence of SS + Pb and CuW + Cu absorber layers, hence a different amount of absorbing material in front of an active layer depending on whether it is odd or even, as shown in Fig.~\ref{ch2:fig:CEEcass}. This structure has visible consequences in the longitudinal development of a shower, resulting in a different amount of energy released in the odd and even layers (cfr Sec.~\ref{ch7:phoCLUE3D}). The HGCAL will have a total of 6 million silicon channels read out independently, organised in 30,000 modules. These modules will be assembled and mounted into 60$\degree$ self-supporting units called \textit{cassettes}.\\

\begin{table*}[!htb]
	\centering
	\caption{
		Features of the silicon sensors in the layers deploying only silicon sensors. The silicon cell size defines two regions, namely the high-density and low-density region.
		\label{ch2:tab:HGCALparameters}
	}
	\renewcommand{\arraystretch}{1.5}
	\begin{tabular}{c|cc|c}
		Region & \multicolumn{2}{c|}{Low-density} & High-density \\
		\hline
		Active thickness ($\mu$m) & \multicolumn{1}{c|}{300} & 200 & 120 \\
		\hline
		Cell size ($\rm cm^2$) & \multicolumn{1}{c|}{1.18} & 1.18 & 0.52 \\
		\hline
		Expected range of fluence ($\times 10^{15}\rm n_{eq}/cm^2$) & \multicolumn{1}{c|}{0.1-0.5} & 0.5-2.5 & 2-7 \\
		\hline
		Largest outer radius ($\rm cm$) &\multicolumn{1}{c|}{$\sim$ 180} & $\sim$ 100 & $\sim$ 70 \\
		\hline
		Smallest inner radius ($\rm cm$) &  \multicolumn{1}{c|}{$\sim$100} & $\sim$ 70 & $\sim$ 35 \\
	\end{tabular}
\end{table*}

Where the dose permits in the CE-H, the silicon sensors will be replaced by plastic scintillators. Consequently, the CE-H is subdivided into two sections: the first 7 layers, where only silicon sensors are deployed; the remaining layers, where the inner part is composed of silicon sensors and the outer part is composed of scintillators. This configuration will result in the $|\eta|>2.4$ region of the HGCAL that will be covered exclusively by silicon sensors. The scintillating cells will have a variable size from 4 $\rm cm^2$ in the inner region to 30 $\rm cm^2$ in the outer region. The scintillation light will be read out directly by on-tile silicon photo-multipliers. The absorber in the CE-H consists of 10 planes of 41.5 mm thick SS plates, followed by another 10 planes with a thickness of 60.7 mm. The first absorber layer, dividing the CE-E from the CE-H, is instead 45 mm thick, also serving as a structural support of the entire CE-E. In total, there will be 240,000 scintillator channels organised in 4,000 boards. For layers featuring both types of active material, the inner silicon component and the outer scintillator component will be assembled into cassettes with an angular width of 30$\degree$, that are later joined together to form a 60$\degree$ unit.

\begin{figure}
	\centering
	\includegraphics[width=\textwidth]{../Figures/Chapter2/OverviewDrawing_March2022}
	\caption{
		Overview of the features of the HGCAL and cross section view of the calorimeter. The CE-E and first layers of the CE-H sections will be made entirely of silicon sensors, while the last layers will be a mixture of silicon sensors and plastic scintillators. The electromagnetic calorimeter (CE-E) comprises 26 layers (27.7$X_0$, $1.5\lambda$), whereas the hadronic calorimeter (CE-H) comprises 7 silicon layers and others 14 layers made of silicon and scintillators ($\sim8.5\lambda$).
		%The transition region between the two components is defined by the expected fluence, which should limited to $8\times10^{13}\rm n_{eq}/cm^2$, and the integrated dose, which should be less than 3 kGy.
		\label{ch2:fig:HGCALsummary}}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.6\textwidth]{../Figures/Chapter2/CEEcass}
	\caption{
		Longitudinal structure of a fundamental unit of the CE-E. Each unit comprises two sampling layers.
		\label{ch2:fig:CEEcass}}
\end{figure}

\begin{figure}[!htb]
	\centering
	\includegraphics[width=\textwidth]{../Figures/Chapter2/ModuleStructure}
	\caption{
		(Left) Representation of the silicon sensors with two possible cell sizes. (Right) The left half-circle shows the layout of a layer where only silicon sensors are present. The radial changes in darkness of colour indicate the different silicon thickness: $300$, $200$, and $120~\mu$m. The solid black line marks the boundary between the high-density and low-density region. The succession of green and yellow colours delimit the 60$\degree$ cassettes. The right half-circle shows the layout of a layer where both silicon sensors and scintillators are present. The blue lines in the scintillator part and the red lines in the silicon part delimit the 30$\degree$ cassettes. Figure adapted from \cite{Bonanomi:2021yex}.
		\label{ch2:fig:HGCALstructure}}
\end{figure}

In conclusion, the new endcap calorimeter will be the first large-scale silicon-based imaging calorimeter employed in a high-energy experiment. This detector will offer the unique capability of performing calorimetry with tracker-like granular information, enabling unprecedented accuracy using position, energy, and timing information. This will open a new era in calorimetry. Such a revolution on the hardware side must be accompanied by another similar revolution on the reconstruction side, both online and offline. The development and optimisation of the offline reconstruction is one of the topics of this thesis and will be discussed in Ch.~\ref{ch7} and Ch.~\ref{ch8}.

