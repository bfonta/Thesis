:PROPERTIES:
:CUSTOM_ID: sec:syst_shape
:END:

For many systematic variations, it is not possible to guarantee /a priori/ that the shape of related distributions is not affected.
On the contrary, often the existence of significant shape dependencies is observed.
Whenever such correlations are found, the full binned shape is taken into account for the systematic uncertainties.
The evaluation of a single uncertainty is achieved by shifting its template up and down, \ie{} by estimating an upward or downward variation corresponding to what can be reasonably expected to cover all possible values.
For continuous variables, this can for instance correspond to \SI{1}{\sigma} intervals around the nominal value.
Related objects depending on those variations must also be accordingly shifted.
For instance, when \taus{} are shifted due to \ac{JES} or \ac{JER} corrections, the \ac{MET} in the event must also take the energy shifts into account.
Concerning the final discriminant, all input features must also be shifted up and down, independently for each systematic source, leading to numerous evaluations of the \ac{pDNN}.
If the same systematic source shifts multiple distributions, those variations are considered together during the \ac{pDNN} inference, leading to a single up or down \ac{pDNN} template.
For example, when shifting the energy scale of jets, we shift the energy of the two AK4 resolved jets or the energy of the boosted AK8 jet, and also propagate the shift to the \ac{MET}.
In the following we provide a list of all shape systematics considered in the \xhhbbtt{} analysis.

* L1 prefiring
Shape uncertainties are obtained to adress the prefiring issue of \ac{ECAL} and Muon Chambers, described in [[#sec:mc_corrections]].
Two independent sets of up and down uncertainties are considered, for both ECAL and Muon Chambers.
The ECAL prefiring uncertainty contains constant 20% uncertainty, to which one adds a statistical uncertainty dependent on \ac{eta} and \ac{pt}, in quadrature.
The Muon Chambers' prefiring uncertainty is defined very similarly, but its statistical component also includes a dependence on \ac{phi}.
While the ECAL prefiring uncertainty is applied to 2016 and 2017 MC simulations only, the muon one is applied to all years.

* Pileup reweighting uncertainty
:PROPERTIES:
:CUSTOM_ID: sec:syst_pu
:END:

The per event \ac{PU} distribution follows a Poisson distribution with the average as its expected value $\langle\mu\rangle$.
The average is computed using [[eq:pileup]], where the inelastic \ac{pp} cross section has a value recommended by \ac{CMS} of $69.2\,\si{\milli\barn}$, for \run{2}.
Given the \SI{\sim 30}{\percent} inefficiencies present in the \ac{CMS} vertex reconstruction in CMS, $\langle\mu\rangle$ does not necessarily agree with the number of reconstructed \acp{PV} in each event, as shown in [[fig:vertex_discrepancies]].
The systematic uncertainty on the \ac{PU} reweighting technique is estimated by applying up and down variations on the \ac{PU} weights.
The variations correspond to using an inelastic \ac{pp} cross section shifted by 4.6%, leading to $66\,\si{\milli\barn}$ for the downward variations and to $72.4\,\si{\milli\barn}$ for the upward variations.
We also recall that \ac{PU} variations are additionally used to correct the normalization used to weight \ac{MC} samples, as described in [[#sec:mc_reweighting]].

#+NAME: fig:vertex_discrepancies
#+CAPTION: Comparisons between data and \ac{MC} of two of the most sensitive variables to \ac{PU}: the number of \acp{PV} (left) and the mean energy density (right), using 2017 \ac{UL} conditions. Courtesy of Pedro Silva.
#+BEGIN_figure
\centering
#+ATTR_LATEX: :width .45\textwidth :center
[[~/org/PhD/Thesis/figures/analysis2/nvtx_mm_log.pdf]]
#+ATTR_LATEX: :width .45\textwidth :center
[[~/org/PhD/Thesis/figures/analysis2/rho_mm.png]]
#+END_figure

* Hadronic $\tau$'s energy scale
The uncertainty on the energy measurement of hadronically-decaying $\tau$ leptons can lead to a change in the distribution of the variables used to search for a \ac{BSM} signature.
An uncertainty on the energy scale of each \tauh{} candidate is considered.
The uncertainties are derived by combining two different measurements: the low and high-$\pt$ measurements of \ztt{} and offshell $\text{q}\bar{\text{q}} \rightarrow \text{W}^{*} \rightarrow \tau\nu$ events[fn:: The $\text{q}\bar{\text{q}} \rightarrow \text{W}^{*} \rightarrow \tau\nu$ process produces high-\ac{pt} \taus{} via highly virtual W bosons with little hadronic activity.], respectively.
As shown in [[fig:tau_unc]], the following \ac{pt}-binned scheme is applied:
+ $\pt(\tau) \leq 34\,\si{\GeV}$: from the low-$\pt$ measurement
+ $34 < \pt(\tau) < 170\,\si{\GeV}$: linearly interpolated between the uncertainties in the low- and high-\ac{pt} measurements
+ $\pt(\tau) \geq 170\,\si{\GeV}$: from the high-$\pt$ measurement
The \num{34} and \SI{170}{\GeV} boundaries represent the mean \ac{pt} values from the two measurements.

#+NAME: fig:tau_unc
#+CAPTION: Illustration of the \acp{TES} corrections as recommended by the \ac{CMS} =Tau= \ac{POG}, and used for our analysis. The corrections were measured using low-\ac{pt} \ztt{} and high-\ac{pt} offshell $\text{q}\bar{\text{q}} \rightarrow \text{W}^{*} \rightarrow \tau\nu$ events. Corrections between the mean $\pt(\tau)$ value in both regimes were linearly interpolated. Taken from internal documentation of the =Tau= \ac{POG}.
#+BEGIN_figure
\centering
#+ATTR_LATEX: :width .65\textwidth :center
[[~/org/PhD/Thesis/figures/analysis2/TESunc.pdf]]
#+END_figure

Four different uncertainties are provided by the =Tau= \ac{POG} to take into account the different $\tau$ decay modes in this analysis.
When considering the uncertainty for a particular decay mode, the shift is applied only to the truth-matched \tauh{} candidates that are reconstructed with that particular decay mode; all other \tauh{} candidates are left unchanged.
The uncertainty sources are considered to be decorrelated between data-taking years and tau decay modes or $\tau$ \ac{pt} ranges.

* Energy corrections for prompt electrons
:PROPERTIES:
:CUSTOM_ID: sec:syst_shape_genuine_electrons
:END:

The energy of prompt electrons in data does not match what the simulations provide.
This is addressed by shifting the energy scale of the data to match the \ac{MC} scale, and to smear the \ac{MC} electron resolution to match the resolution in data, as recommended within the \ac{CMS} Collaboration.
This corrections are applied before any selection stage in the analysis.
Corrections are only applied to genuine electrons reconstructed as such.

A set of uncertainties is associated to the corrections being applied, as a change in electron energy can affect the final result in several ways.
Some events with electrons can for instance be excluded if they were previously part of the analysis, or vice-versa, based on some kinematic cut.
The energy scaling and smearing are considered separately, leading to four variations in total.
In practice, the energy of the electrons are corrected by applying the variations on the original, uncorrected electron four-momenta.
The uncertainties are only applied to genuine electrons.
Uncertainties on genuine electrons reconstructed as taus are instead computed using the =deepTau= uncertainties covered in the next subsection. 

Equivalent shape uncertainties for muons are known to be negligible and are not implemented.
If they were included, they would be structured in the same way as described above for electrons.

* Energy scale corrections for electrons and muons faking taus
The \ac{HPS} algorithm, as described in [[#sec:offline_reco_taus]], identifies hadronically decaying \taus{}.
Ocasionally, both electrons and muons are misidentified as \tauhs{}.
For the case of electrons, this might happen when there is one charged hadron and zero or none neutral hadrons (see [[tab:tau_decays]]).
When only one charged hadron is present, with a \ac{BR} of 11.5%, the electron can be misidentified as the charged hadron.
When a neutral hadron is additionally present, with a \ac{BR} of 26.0%, the fake electron can be wrongly reconstructed with additional bremsstrahlung photons.
Muons instead can be misidentified just like the electrons, but only when no neutral hadron is present, as they radiate much less than electrons.

The uncertainties to be applied to the energy scale of electrons reconstructed as \tauhs{} are provided by the \ac{CMS} =Tau= \ac{POG}.
They are treated as uncorrelated across different decay modes and data-taking years.
The uncertainties are dependent on the two decay modes mentioned above, and are only applied to truth-matched electrons and muons.
The muon energy scales were added for completeness only, as th erecommended approach is to simply assign a 1% flat uncertainty.

* Jet energy scales and resolutions
Uncertainties on the \acp{JES} and \acp{JER} are provided by the =JetMET= \ac{POG}.
Concerning the \acp{JES}, a reduced set of 11 sources is used, as recommended.
The sources take into consideration dependence effects on \ac{ISR}, \ac{FSR}, jet flavour, kinematics, detector regions and miscalibrations.
The uncertainties are the same for AK4 and AK8 jets.
They are once more propagated to the definition of MET, replacing all nominal jets in an event by the corrected ones.
This is repeated 11 times, leading to 22 variation templates.
Concerning the \acp{JER}, up and down variations are again centrally provided for all jets, taking into account their clustering radii (AK4 or AK8).
The corrections are then applied before performing any selection on the jets and \ac{MET}.

* Scale factors for tau identification
The uncertainties arising by the application of the =DeepTau= tau lepton identification \acp{SF} do not modify the single objects, but rather overall event weight.
All \acp{SF} are centrally provided by the \ac{CMS} =Tau= \ac{POG}.

+ *Discrimination against jets*:
  The \acp{SF} are provided in bins of the $\tau$ decay mode, and the \ac{pt} dependence is fitted using linear functions.
  Two statistical uncertainties, decorrelated across decay mode and data-taking period, arise from the linear fit to the \ac{pt} distributions.
  Several systematic components are defined, based on the correlation between decay mode and data-taking periods.
  High-\ac{pt} \taus{} of $\pt > 140\,\si{\GeV}$ include two additional systematic contributions.
  An additional systematic is included to correct for extrapolations when the hadronically-decaying $\tau$ has $\pt > 300\,\si{\GeV}$.
  In total, 18 systematic sources are considered, per data-taking period.

+ *Discrimination against electrons*:
  The \acp{SF} are provided as a function of data-taking years and $\tau(\eta)$, being uncorrelated across both.
  Two different uncertainties are identified per data-taking period, one for the \ac{CMS} barrel and one for the endcaps.

+ *Discrimination against muons*:
  The uncertainties are provided in five $|\eta|$ bins, but are found to be negligible, and are thus not considered.

* Trigger scale factors
The uncertainties arising from the application of the trigger \acp{SF} do not modify single objects, but only the overall weight of each event.

+ *Legacy triggers*:
  Four different uncertainties are provided by the \ac{CMS} =Tau= \ac{POG}, binned in the decay mode of the hadronic taus, and they take into account the hadronically decaying legs of the $\tau\tau$ pair.
  Two more trigger uncertainties are used to cover the lepton legs in the \eletau{} and \mutau{} channels.
  The uncertainties are provided by the same sources which provided the nominal trigger \acp{SF}, described in [[#sec:lepton_trigger_sfs]].

+ *MET trigger*:
  Uncertainties arising from the $\metnomu$ \acp{SF} are also considered.
  They are extracted from the fitted parameters of the sigmoid function in [[eq:sigmoid]], and propagated using the error propagation of a ratio.
  The maximum and minimum allowed values of the sigmoid functions are used whenever the event has a $\metnomu$ value beyond the fit validity range.
  This can only happen for $\metnomu > 350\,\si{\GeV}$, since values below the minimum \ac{MET} threshold are removed when defining the \ac{MET} trigger region in [[#sec:trigger_regions]].

+ *Single tau trigger*:
  For the single-$\tau$ trigger, we use as uncertainties the ones listed in [[tab:singleTauSFs]], which are centrally provided.

* B-tagging scale factors
Uncertainties on \btag{} \acp{SF} are provided by the \ac{CMS} =BTV= \ac{POG}.
The impact on the purity of b-jets is estimated by varying the contamination from udsg+c and b+c jets in heavy and light flavor regions, respectively, by $\pm 20\%$.
Additionally, statistical fluctuations are accounted for by providing weights where statistical uncertainties in each bin of the \btag{} discriminant are multiplied by linear and quadratic functions.
Finally, a dedicated statistical uncertainty is also considered for charm-initated jets.
@understand@
In total, 8 systematic uncertainties are considered,per data-takin period.
These uncertainty does not modify single objects, but rather overall event weight.

* Pile-up jet identification
Uncertainties on the \ac{PU} jet identification \acp{SF} are provided by the =JetMET= \ac{POG} as a function of jet \ac{pt} and \ac{eta}, being applied on an event-by-event base.
This uncertainty does not modify the single objects, but only the overall event weights.

* Monte Carlo finite sample size
The limited number of simulated events in each bins of the discriminatn distributions in the final fit also carry an uncertainty, independent for each bin.
The Barlow-Beeston approach [[cite:&barlow-beeston]] is used to take such uncertainties into account, introducing a set of nuisance parameters multiplying the expected number of events in each bin, for each background source.
